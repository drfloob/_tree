/*! _tree - v0.6.0 - 2014-02-18
    (c) 2013 A.J. Heller
    _tree.js may be freely distributed under the MIT License.
*/

!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["underscore"],b):"object"==typeof exports?module.exports=b(require("underscore")):a._tree=b(a._)}(this,function(a){"use strict";function b(b,c){var d=Array.prototype.slice.call(arguments,2);a.each(b.defaults.callbacks[c],function(c){a.partial(c,b).apply(null,d)})}function c(b){a.each(b.defaults.mixins,function(c){c.tree&&a.each(c.tree,function(a,c){b[c]=a}),c.node&&a.each(c.node,function(a,c){b.walk(function(b){b[c]=a})})}),d(b)}function d(b,c,e){c||(c=b.root()),c.__tree=b,e&&(c.__parent=e),a.each(c.children(),function(a){d(b,a,c)})}function e(a){try{Object.freeze(a)}catch(c){}a.walk(function(a){try{Object.freeze(a),Object.freeze(a.__children)}catch(b){}}),b(a,"afterUpdate")}function f(b){return b=b?a.clone(b):{},b.callbacks=a.defaults(a.clone(b.callbacks||{}),i.callbacks),b.mixins=a.union(b.mixins||[],i.mixins),b=a.defaults(b,i)}var g,h,i,j,k={};return k.inflate=function(a,d,g){g=f(g),d=g.inflate=d||g.inflate;var h=new g.treeClass(g,a,d);return c(h),b(h,"beforeFreeze"),e(h),h},k.create=function(a){return k.inflate(null,null,a)},k.inflate.byKey=function(b){return b=b||"children",function(c){this.setNode(new k.Node(this.tree,c)),a.has(c,b)&&this.children(c[b])}},k.inflate.byAdjacencyList=function(b){var c,d,e;if(this.setNode(new k.Node(this.tree,a.first(b))),b.length>1){if(!a.isArray(b[1])||b.length>2)throw"invalid adjacency list";for(c=b[1],e=0;e<c.length;e++)d=[c[e]],c.length>1&&a.isArray(c[e+1])&&(d.push(c[e+1]),e++),this.children([d])}},k.inflate.onlyLeavesList=function(b){if(!a.isArray(b)||b.length>1)throw"invalid leaves list";a.isArray(a.first(b))?(this.setNode(new k.Node(this.tree)),this.children(a.map(a.first(b),function(a){return[a]}))):this.setNode(new k.Node(this.tree,a.first(b)))},k.fromNode=function(a,d){var g;return d=f(d),g=new d.treeClass(d),g.__root=a.constructor.clone(g,a),c(g),b(g,"beforeFreeze"),e(g),g},g=function(b,c,d,e){var f,i,j;this.defaults=b,f=a.uniqueId(),i=e||0;try{Object.defineProperties(this,{__id:{value:f,writable:!0,enumerable:!1,configurable:!1},__nextNodeId:{value:i,writable:!0,enumerable:!1,configurable:!1},__batch:{value:0,writable:!0,enumerable:!1,configurable:!1}})}catch(k){this.__id=f,this.__nextNodeId=i,this.__batch=0}j=c&&d?g.inflate(this,c,d):new h(this);try{Object.defineProperties(this,{__root:{writable:!0,enumerable:!1,configurable:!1,value:j}})}catch(k){this.__root=j}},k.Tree=g,g.clone=function(a){var b=new a.constructor(a.defaults);return b.__root=a.root().constructor.clone(b,a.root()),b.__nextNodeId=a.__nextNodeId,b.__id=a.__id,b},g.inflate=function(b,c,d){var e,f;return f={tree:b,setNode:function(a){e=a},children:function(c){a.each(c,function(a){var c=new b.constructor(b.defaults,a,d,b.__nextNodeId);e.__children.push(c.root()),c.root().__parent=e,b.__nextNodeId=c.__nextNodeId})}},b.__root=e,d.call(f,c),e},g.prototype.root=function(){return this.__root},g.prototype.findNode=function(a,b,c){if(!(a instanceof h))throw"not a node";if(!this.equals(a.__tree))return!1;var d=!1;return this.walk(function(b){!d&&a.equals(b)&&(d=b)},b,c),d},g.prototype.findNodeByData=function(b,c,d){var e,f,g=!1;return a.isUndefined(b)?!1:(a.isObject(b)&&!a.isArray(b)?(f=a.keys(b),e=function(c){return!a.isObject(c)||a.isArray(c)?!1:a.isEqual(b,a.partial(a.pick,c).apply(a,f))}):e=function(c){return a.isEqual(b,c)},this.walk(function(a){!g&&e(a.__data)&&(g=a)},c,d),g)},g.prototype.walk=function(b,c,d){c=c||this.defaults.walk;var e,f,g=[],h=[];if(d){if(!this.containsNode(d))throw new Error("startNode does not exist in the tree")}else d=this.root();for(e={queue:function(a){g=g.concat(a)},push:function(a){g=a.concat(g)},recurse:function(b){a.each(b,function(a){c.call(e,a)})},queueRecurse:function(a){h=h.concat(a)}},c.call(e,d);h.length>0;)f=h.shift(),c.call(e,f);a.each(g,b)},g.prototype.walk.dfpre=function(a){this.queue(a),this.recurse(a.children())},g.prototype.walk.dfpost=function(a){this.recurse(a.children()),this.queue(a)},g.prototype.walk.bfpre=function(a){a.parent()||this.queue([a]),this.queue(a.children()),this.recurse(a.children())},g.prototype.walk.bfpost=function(b){b.parent()||this.push([b]),this.push(b.children());var c=a.clone(b.children());c.reverse(),this.queueRecurse(c)},g.prototype.equals=function(a){return a instanceof g&&this.__id===a.__id},g.prototype.containsNode=function(a){return this.findNode(a)instanceof h},g.prototype.containsData=function(a){return this.findNodeByData(a)instanceof h},g.prototype.moveNode=function(a,b){return this.batch().findNode(a).remove().findNode(b).addChildNode(a).end()},g.prototype.on=function(d,f){var h,i;return h=g.clone(this),i=a.isArray(f)?f:[f],h.defaults.callbacks[d]=h.defaults.callbacks[d].concat(i),c(h),b(h,"beforeFreeze"),e(h),h},g.prototype.off=function(d,f){var h,i;return h=g.clone(this),i=a.isArray(f)?f:[f],h.defaults.callbacks[d]=a.partial(a.without,h.defaults.callbacks[d]).apply(a,i),c(h),b(h,"beforeFreeze"),e(h),h},g.prototype.mixin=function(d){var f;return f=g.clone(this),a.contains(f.defaults.mixins,d)||f.defaults.mixins.push(d),c(f),b(f,"beforeFreeze"),e(f),f},g.prototype.batch=function(){var a;return a=g.clone(this),a.__batch++,c(a),a},g.prototype.isBatch=function(){return this.__batch>0},g.prototype.end=function(){if(!this.isBatch())throw"Called `tree.end` when not in batch mode.";return this.__batch--,this.isBatch()||e(this),this},h=function(a,b){try{Object.defineProperties(this,{__tree:{value:a,writable:!0,enumerable:!1,configurable:!1},__data:{value:b,writable:!0,enumerable:!1,configurable:!1},__children:{value:[],writable:!0,enumerable:!1,configurable:!1},__id:{value:a.__nextNodeId,writable:!0,enumerable:!1,configurable:!1}})}catch(c){this.__tree=a,this.__data=void 0,this.__children=[],this.__id=a.__nextNodeId}a.__nextNodeId=a.__nextNodeId+1},k.Node=h,h.clone=function(b,c,d){var e=new c.constructor(b);return e.__data=c.__data,e.__children=a.map(c.children(),function(a){return c.constructor.clone(b,a,d)}),a.each(e.__children,function(a){a.__parent=e}),d||(e.__id=c.__id,b.__nextNodeId--),e},j=function(b,c){var d,e,f;return d=this,e=b&&a.has(b,"constructor")?b.constructor:function(){return d.apply(this,arguments)},a.extend(e,d,c),f=function(){this.constructor=e},f.prototype=d.prototype,e.prototype=new f,b&&a.extend(e.prototype,b),e.__super__=d.prototype,e},g.extend=h.extend=j,h.prototype.data=function(a){if(!a)return this.__data;var d,f;return this.tree().isBatch()?(this.__data=a,this.tree()):(d=g.clone(this.tree()),f=d.findNode(this),f.__data=a,c(d),b(d,"beforeFreeze"),b(d,"beforeFreeze.data",f),e(d),d)},h.prototype.children=function(){return this.__children},h.prototype.parent=function(){return this.__parent},h.prototype.tree=function(){return this.__tree},h.prototype.id=function(){return this.__id},h.prototype.parseAndAddChild=function(a,d){d=d||this.__tree.defaults.inflate;var f,h,i,j;return j=this.tree(),f=new j.constructor(j.defaults,a,d,j.__nextNodeId),j.isBatch()?(this.__children.push(f.root()),j.__nextNodeId=f.__nextNodeId,c(j),j):(h=g.clone(j),i=h.findNode(this),i.__children.push(f.root()),h.__nextNodeId=f.__nextNodeId,c(h),b(h,"beforeFreeze"),b(h,"beforeFreeze.parseAndAddChild",f.root()),e(h),h)},h.prototype.addChildNode=function(a){var d,f,h;return this.tree().isBatch()?(h=a.constructor.clone(this.tree(),a,!0),this.__children.push(h),c(this.tree()),this.tree()):(d=g.clone(this.tree()),f=d.findNode(this),d.__nextNodeId=this.tree().__nextNodeId,h=a.constructor.clone(d,a,!0),f.__children.push(h),c(d),b(d,"beforeFreeze"),b(d,"beforeFreeze.addChildNode",h),e(d),d)},h.prototype.equals=function(a){return this.__tree.equals(a.__tree)&&this.__id===a.__id},h.prototype.remove=function(){if(this===this.tree().root())throw new Error("cannot delete the root node");var d,f,h;return this.tree().isBatch()?(h=this.parent(),h.__children=a.without(h.__children,this),c(this.tree()),h.tree()):(d=g.clone(this.__tree),f=d.findNode(this),h=d.findNode(this.__parent),h.__children=a.without(h.__children,f),c(d),b(d,"beforeFreeze"),b(d,"beforeFreeze.remove",h),e(d),d)},h.prototype.removeAll=function(d){var f,h,i,j,k;return f=this.tree(),h=this,this.tree().isBatch()?(k=a.map(d,function(b){return a.find(h.children(),function(a){return a.equals(b)})}),this.__children=a.difference(this.__children,k),c(this.tree()),this.tree()):(i=g.clone(this.__tree),j=i.findNode(this),k=a.map(d,function(b){return a.find(j.children(),function(a){return a.equals(b)})}),j.__children=a.difference(j.__children,k),c(i),b(i,"beforeFreeze"),b(i,"beforeFreeze.removeAll",j),e(i),i)},i={treeClass:k.Tree,inflate:k.inflate.byKey(),walk:g.prototype.walk.dfpre,deleteRecursive:!0,callbacks:{afterUpdate:[],beforeFreeze:[],"beforeFreeze.data":[],"beforeFreeze.parseAndAddChild":[],"beforeFreeze.addChildNode":[],"beforeFreeze.remove":[]},mixins:[]},k});
//# sourceMappingURL=dist/_tree.min.js.map